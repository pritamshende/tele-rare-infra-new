name: Complete Production CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  # Application Configuration
  IMAGE_NAME: tele-rare-backend
  IMAGE_TAG: ${{ github.sha }}
  K8S_NAMESPACE: tele-rare
  
  # Azure Configuration
  ACR_NAME: ${{ secrets.ACR_NAME }}
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AZURE_REGION: eastus
  
  # Tool Versions
  JAVA_VERSION: '17'
  TERRAFORM_VERSION: '1.6.0'
  
  # Quality & Security
  SONAR_HOST_URL: https://sonarcloud.io
  ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}

jobs:
  # ============================================================================
  # STAGE 1: SECURITY SCANNING
  # ============================================================================
  
  legitify-security-scan:
    name: ğŸ”’ Legitify GitHub Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run Legitify Security Scan
        uses: Legit-Labs/legitify@main
        with:
          # Fine-grained GitHub Personal Access Token
          github_token: ${{ secrets.PAT_FOR_LEGITIFY }}
          
          # Analyze only this repository (not entire organization)
          analyze_self_only: "true"
          
          # Enable verbose scorecard for detailed security scoring
          scorecard: "verbose"
          
          # Upload results to GitHub Security tab (Code Scanning)
          upload_code_scanning: "true"
          
          # Save results as downloadable artifact
          artifact_name: "legitify-security-report"
          
          # Use latest stable Legitify version
          legitify_base_version: "1.0"
          
          # Optional: Fail workflow on policy violations
          # fail_on_errors: "true"

      - name: ğŸ“Š Generate Security Summary
        if: always()
        run: |
          echo "## ğŸ”’ Legitify Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **GitHub repository security analysis completed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š View Detailed Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Tab:** Go to \`Security â†’ Code scanning â†’ Legitify\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Scorecard:** Check workflow logs above for detailed scoring" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** Download \`legitify-security-report\` below for offline review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ›¡ï¸ Security Policies Checked:" >> $GITHUB_STEP_SUMMARY
          echo "- Branch protection rules" >> $GITHUB_STEP_SUMMARY
          echo "- Repository permissions" >> $GITHUB_STEP_SUMMARY
          echo "- Webhook configurations" >> $GITHUB_STEP_SUMMARY
          echo "- Secret scanning settings" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency review" >> $GITHUB_STEP_SUMMARY

  secret-scanning:
    name: ğŸ” Secret Detection (Gitleaks)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: ğŸ“Š Secret Scan Summary
        if: always()
        run: |
          echo "## ğŸ” Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Git history scanned for exposed secrets, API keys, and credentials" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 2: BUILD & TEST
  # ============================================================================

  build-and-test:
    name: ğŸ—ï¸ Build and Test Application
    runs-on: ubuntu-latest
    needs: [legitify-security-scan, secret-scanning]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”§ Build with Maven
        run: |
          echo "Building application..."
          mvn clean package -DskipTests
          echo "âœ… Build completed successfully!"

      - name: ğŸ§ª Run Unit Tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "Running unit tests..."
          mvn test
          echo "âœ… Tests completed!"

      - name: ğŸ“ˆ Generate Test Coverage Report
        if: github.event.inputs.skip_tests != 'true'
        run: mvn jacoco:report

      - name: ğŸ“Š Upload Test Results
        if: always() && github.event.inputs.skip_tests != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 7

      - name: ğŸ“¦ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

      - name: ğŸ“Š Build Summary
        run: |
          echo "## ğŸ—ï¸ Build & Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Application built successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Java Version:** ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Tool:** Maven" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** Available for download below" >> $GITHUB_STEP_SUMMARY

  code-quality-analysis:
    name: ğŸ“Š SonarQube Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    if: secrets.SONAR_TOKEN != ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: ğŸ” Run SonarQube Analysis
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Quality Analysis Summary
        run: |
          echo "## ğŸ“Š Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **SonarQube analysis completed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results at: ${{ env.SONAR_HOST_URL }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 3: CONTAINER BUILD & SECURITY
  # ============================================================================

  build-and-scan-container:
    name: ğŸ³ Build and Scan Container Image
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality-analysis]
    if: |
      always() && 
      needs.build-and-test.result == 'success' &&
      (needs.code-quality-analysis.result == 'success' || needs.code-quality-analysis.result == 'skipped')
    permissions:
      contents: read
      security-events: write
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: ğŸ—ï¸ Build Docker Image (for scanning)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: ğŸ” Run Trivy Container Scan (SARIF for Security Tab)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          vuln-type: 'os,library'

      - name: ğŸ“¤ Upload Trivy Results to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'container-vulnerability-scan'

      - name: ğŸ” Run Trivy Container Scan (Table for Artifact)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true

      - name: ğŸ“¤ Upload Trivy Report as Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-vulnerability-report
          path: trivy-report.txt
          retention-days: 30

      - name: ğŸš€ Push Docker Image to ACR
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}-latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: ğŸ“Š Container Security Summary
        if: always()
        run: |
          echo "## ğŸ³ Container Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Trivy vulnerability scan completed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š View Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Tab:** \`Security â†’ Code scanning â†’ Container scan\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** Download \`trivy-vulnerability-report\` below" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "âœ… **Image pushed to ACR successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Image built but not pushed** (only push on main branch)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # STAGE 4: INFRASTRUCTURE SECURITY (if Terraform exists)
  # ============================================================================

  terraform-security-scan:
    name: ğŸ—ï¸ Terraform Security Scan
    runs-on: ubuntu-latest
    needs: legitify-security-scan
    if: hashFiles('**/*.tf') != ''
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ğŸ¨ Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: ğŸ”§ Terraform Init
        run: terraform init -backend=false

      - name: âœ… Terraform Validate
        run: terraform validate

      - name: ğŸ” Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: true
          download_external_modules: true

      - name: ğŸ“¤ Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: 'terraform-security'

      - name: ğŸ” Run Trivy IaC Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
          severity: 'HIGH,CRITICAL'

      - name: ğŸ“¤ Upload Trivy IaC Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-iac-results.sarif'
          category: 'infrastructure-security'

      - name: ğŸ“Š IaC Security Summary
        if: always()
        run: |
          echo "## ğŸ—ï¸ Infrastructure Security Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Terraform security analysis completed!**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 5: KUBERNETES MANIFEST SECURITY (if K8s manifests exist)
  # ============================================================================

  kubernetes-security-scan:
    name: â˜¸ï¸ Kubernetes Security Scan
    runs-on: ubuntu-latest
    needs: legitify-security-scan
    if: hashFiles('k8s-gitops/**/*.yaml') != '' || hashFiles('k8s/**/*.yaml') != ''
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run Kubesec Security Scan
        uses: controlplaneio/kubesec-action@v0.0.2
        with:
          input: k8s-gitops/
          format: json
          exit-code: "0"
        continue-on-error: true

      - name: ğŸ” Run Trivy K8s Manifest Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'k8s-gitops/'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: ğŸ“Š K8s Security Summary
        if: always()
        run: |
          echo "## â˜¸ï¸ Kubernetes Security Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Kubernetes manifests scanned for security issues**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 6: DEPLOYMENT
  # ============================================================================

  deploy-to-kubernetes:
    name: ğŸš€ Deploy to Azure Kubernetes Service
    runs-on: ubuntu-latest
    needs: [build-and-scan-container]
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') &&
      needs.build-and-scan-container.result == 'success'
    permissions:
      contents: write
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: ğŸ“¥ Checkout Infrastructure Repository
        uses: actions/checkout@v4
        with:
          repository: pritamshende/tele-rare-infra-new
          token: ${{ secrets.PAT_FOR_LEGITIFY }}
          path: infra
          fetch-depth: 0

      - name: ğŸ”§ Update Kubernetes Deployment Manifest
        working-directory: infra
        run: |
          echo "Updating deployment manifest with new image tag..."
          
          # Update image tag in deployment.yaml
          sed -i "s|image: .*/${{ env.IMAGE_NAME }}:.*|image: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}|g" k8s-gitops/deployment.yaml
          
          # Verify the change
          echo "âœ… Updated image reference:"
          grep "image:" k8s-gitops/deployment.yaml | grep "${{ env.IMAGE_NAME }}"

      - name: ğŸ“ Commit and Push Manifest Changes
        working-directory: infra
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add k8s-gitops/deployment.yaml
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ğŸš€ Deploy ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} to ${{ github.event.inputs.environment || 'production' }} [skip ci]

            Triggered by: ${{ github.actor }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Workflow: ${{ github.workflow }}"
            
            git push
            echo "âœ… Deployment manifest updated and pushed successfully!"
          fi

      - name: ğŸ”„ Trigger ArgoCD Application Sync
        if: secrets.ARGOCD_AUTH_TOKEN != ''
        run: |
          echo "ğŸ”„ Triggering ArgoCD sync for tele-rare-backend application..."
          
          response=$(curl -k -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.ARGOCD_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST "${{ env.ARGOCD_SERVER }}/api/v1/applications/tele-rare-backend/sync" \
            -d '{
              "prune": false,
              "dryRun": false,
              "strategy": {
                "hook": {
                  "force": true
                }
              }
            }')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Response Code: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "âœ… ArgoCD sync triggered successfully!"
          else
            echo "âš ï¸ ArgoCD sync failed with status code: $http_code"
            echo "Response: $body"
            exit 1
          fi

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Namespace** | \`${{ env.K8S_NAMESPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor ArgoCD dashboard for sync status" >> $GITHUB_STEP_SUMMARY
          echo "2. Check pod status: \`kubectl get pods -n ${{ env.K8S_NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. View logs: \`kubectl logs -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 7: FINAL REPORT
  # ============================================================================

  pipeline-completion-report:
    name: ğŸ“‹ Pipeline Completion Report
    runs-on: ubuntu-latest
    needs: 
      - legitify-security-scan
      - secret-scanning
      - build-and-test
      - code-quality-analysis
      - build-and-scan-container
      - terraform-security-scan
      - kubernetes-security-scan
      - deploy-to-kubernetes
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Comprehensive Pipeline Report
        run: |
          echo "# ğŸ¯ CI/CD Pipeline Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Pipeline Stages Status:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Legitify Security Scan | ${{ needs.legitify-security-scan.result == 'success' && 'âœ… Passed' || needs.legitify-security-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Secret Scanning | ${{ needs.secret-scanning.result == 'success' && 'âœ… Passed' || needs.secret-scanning.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Build & Test | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || needs.build-and-test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Code Quality | ${{ needs.code-quality-analysis.result == 'success' && 'âœ… Passed' || needs.code-quality-analysis.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Container Security | ${{ needs.build-and-scan-container.result == 'success' && 'âœ… Passed' || needs.build-and-scan-container.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Terraform Security | ${{ needs.terraform-security-scan.result == 'success' && 'âœ… Passed' || needs.terraform-security-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| â˜¸ï¸ Kubernetes Security | ${{ needs.kubernetes-security-scan.result == 'success' && 'âœ… Passed' || needs.kubernetes-security-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deployment | ${{ needs.deploy-to-kubernetes.result == 'success' && 'âœ… Passed' || needs.deploy-to-kubernetes.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Security Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security scan results are available in:" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Security Tab:** \`Security â†’ Code scanning\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Artifacts:** Download detailed reports below" >> $GITHUB_STEP_SUMMARY
          echo "- **Individual Job Logs:** Check each job above for details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ›¡ï¸ Security Scans Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub repository security policies (Legitify)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret detection in git history (Gitleaks)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container vulnerability scanning (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code quality analysis (SonarQube)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.terraform-security-scan.result }}" != "skipped" ]; then
            echo "- âœ… Infrastructure as Code security (Checkov, Trivy)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.kubernetes-security-scan.result }}" != "skipped" ]; then
            echo "- âœ… Kubernetes manifest security (Kubesec)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.legitify-security-scan.result }}" == "success" ] && \
             [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.build-and-scan-container.result }}" == "success" ]; then
            echo "## âœ… Pipeline Execution: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All critical stages completed successfully! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Pipeline Execution: COMPLETED WITH ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some stages failed or were skipped. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“š Additional Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [View Security Alerts](${{ github.server_url }}/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline completed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ## ğŸ¯ CI/CD Pipeline Results
            
            **Status:** ${{ needs.legitify-security-scan.result == 'success' && needs.build-and-test.result == 'success' && 'âœ… All checks passed!' || 'âš ï¸ Some checks failed' }}
            
            ### Pipeline Stages:
            - ğŸ”’ Security Scan: ${{ needs.legitify-security-scan.result == 'success' && 'âœ…' || 'âŒ' }}
            - ğŸ—ï¸ Build & Test: ${{ needs.build-and-test.result == 'success' && 'âœ…' || 'âŒ' }}
            - ğŸ³ Container Scan: ${{ needs.build-and-scan-container.result == 'success' && 'âœ…' || 'âŒ' }}
            
            **Commit:** \`${{ github.sha }}\`
            **Triggered by:** @${{ github.actor }}
            
            [View Full Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ============================================================================
  # NOTIFICATIONS (Optional)
  # ============================================================================

  notify-on-failure:
    name: ğŸ“§ Notify on Pipeline Failure
    runs-on: ubuntu-latest
    needs: [pipeline-completion-report]
    if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“§ Send Failure Notification
        run: |
          echo "ğŸš¨ Pipeline failed on main branch!"
          echo "Workflow: ${{ github.workflow }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # TODO: Integrate with Slack, Teams, Email, etc.
          # Example for Slack:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data "{\"text\":\"Pipeline failed on main branch!\"}" \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
